<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>NeuraScope</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/modern-css-reset/dist/reset.min.css">
<style>
body{font-family:system-ui,sans-serif;margin:0;padding:0 0 2rem}
header{background:#0077cc;color:#fff;padding:.6rem 1rem;font-size:1.3rem;font-weight:bold}
.wrapper{padding:1.2rem}
.tabbar{display:flex;gap:.6rem;margin-bottom:1rem}
.tabbar button{padding:.4rem 1rem;border:1px solid #0077cc;background:#fff;color:#0077cc}
.tabbar button.active{background:#0077cc;color:#fff}
.card{border:1px solid #ddd;border-radius:.75rem;padding:1rem;margin-block:1rem;position:relative}
.fav{position:absolute;top:.4rem;right:.5rem;border:none;background:none;font-size:1.4rem;cursor:pointer}
select{margin-bottom:.8rem}
.toc{margin:.5rem 0}
</style>
</head>
<body>

<header>NeuraScope</header>
<div class="wrapper">

<nav class="tabbar">
  <button data-tab="arxiv" class="active">arXiv</button>
  <button data-tab="paper">論文フィード</button>
  <button data-tab="news">ニュース</button>
  <button data-tab="blog">技術ブログ</button>
  <button onclick="location.href='/favorites'">★ お気に入り</button>
</nav>

<div class="toc">
  <label>目次:
    <select id="toc-select"></select>
  </label>
</div>

<!-- arXiv -->
<section id="tab-arxiv">
  {% for d,plist in arxiv_days.items() %}
    <div class="grp" id="arxiv-{{d}}" {% if not loop.first %}style="display:none"{% endif %}>
      {% for p in plist %}
      <article class="card">
        <button class="fav" data-kind="paper" data-id="{{p.id}}">{{ '★' if p.favorite else '☆' }}</button>
        <h3><a href="{{ url_for('paper_detail', paper_id=p.id) }}">{{ p.title_ja }}</a></h3>
        {{ p.analysis_html|safe }}
      </article>
      {% endfor %}
    </div>
  {% endfor %}
</section>

<!-- 外部フィード -->
{% for cat in ['paper','news','blog'] %}
<section id="tab-{{cat}}" style="display:none">
  {% for d,alist in ext_by_cat[cat].items() %}
    <div class="grp-{{cat}}" id="{{cat}}-{{d}}" {% if not loop.first %}style="display:none"{% endif %}>
      {% for a in alist %}
      <article class="card">
        <button class="fav" data-kind="article" data-id="{{a.id}}">{{ '★' if a.favorite else '☆' }}</button>
        <h4><a href="{{ a.link }}" target="_blank">{{ a.title_ja or a.title_en }}</a></h4>
        {% if a.summary_ja or a.summary_en %}
          <p>{{ a.summary_ja or a.summary_en }}</p>
        {% endif %}
      </article>
      {% endfor %}
    </div>
  {% endfor %}
</section>
{% endfor %}
</div><!-- /.wrapper -->

<script>
/* タブ切替 */
const tabs=document.querySelectorAll(".tabbar button[data-tab]");
tabs.forEach(btn=>{
  btn.onclick=()=>{
    tabs.forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    const id="tab-"+btn.dataset.tab;
    document.querySelectorAll("section[id^='tab-']").forEach(sec=>{
      sec.style.display=sec.id===id?"":"none";
    });
    populateToc(btn.dataset.tab);
  };
});

/* 目次生成 */
function populateToc(cat){
  const sel=document.getElementById("toc-select");
  sel.innerHTML="";
  const selector=cat==="arxiv"?".grp":".grp-"+cat;
  document.querySelectorAll(selector).forEach(div=>{
    const d=div.id.split("-").pop();
    sel.insertAdjacentHTML("beforeend",`<option value="${div.id}">${d}</option>`);
  });
  sel.onchange=e=>{
    const id=e.target.value;
    document.querySelectorAll(selector).forEach(div=>{
      div.style.display=div.id===id?"":"none";
    });
  };
  sel.dispatchEvent(new Event("change"));
}
populateToc("arxiv");

/* お気に入りトグル */
function toggleFav(btn){
  fetch(`/api/favorite/${btn.dataset.kind}/${btn.dataset.id}`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({favorite:btn.textContent==="☆"})
  }).then(r=>r.json()).then(j=>{
    if(j.ok) btn.textContent=j.favorite?"★":"☆";
  });
}
document.addEventListener("click",e=>{
  if(e.target.classList.contains("fav")) toggleFav(e.target);
});
</script>

</body>
</html>
